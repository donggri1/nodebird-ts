{% extends 'layout.html' %}

{% block content %}
<div class="container">
  <div class="post-header">
    <h1>{{post.title}}</h1>
    <div class="post-meta">
      <span>작성자: {{post.User.nick}}</span>
      <span>작성일: {{post.createdAt.toLocaleString()}}</span>
    </div>
  </div>
  <hr>
  <div class="post-content">
    <p>{{post.content}}</p>
    {% if post.img %}
      <img src="/uploads/{{post.img}}" alt="게시글 이미지" class="post-image">
    {% endif %}
  </div>
  <hr>
  <div class="post-actions">
    <a href="/community" class="btn">목록으로</a>
    {% if user and user.id == post.UserId %}
      <a href="/community/{{post.id}}/edit" class="btn">수정</a>
      <button class="btn btn-sm btn-danger delete-btn" data-post-id="{{ post.id }}">삭제</button>
    {% endif %}
  </div>

  {# Comment Section #}
  <div class="comment-section mt-4">
    <h3>댓글</h3>
    {% if user %} {# Only show comment form if user is logged in #}
    <form action="/community/{{post.id}}/comment" method="post" class="mb-4">
      <div class="form-group">
        <textarea name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary mt-2">댓글 작성</button>
    </form>
    {% else %}
    <p>댓글을 작성하려면 <a href="/auth/login">로그인</a>해주세요.</p>
    {% endif %}

    <div class="comments-list">
      {% if post.Comments and post.Comments.length > 0 %}
        {% for comment in post.Comments %}
          <div class="comment-item border p-3 mb-2 rounded">
            <div class="comment-meta d-flex justify-content-between align-items-center">
              <strong>{{ comment.User.nick }}</strong>
              <small>{{ comment.createdAt.toLocaleString() }}</small>
            </div>
            <p class="comment-content mt-2">{{ comment.content }}</p>
            {% if user and user.id == comment.UserId %}
               <form action="/community/{{post.id}}/comment/{{comment.id}}" method="post" style="display: inline;">
                <input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="btn btn-sm btn-danger">삭제</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>아직 댓글이 없습니다.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
    document.querySelectorAll('.delete-btn').forEach(button => {
        debugger;
        button.addEventListener('click', async (e) => {
            const postId = e.target.dataset.postId;
            if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                try {
                    const response = await fetch(`/community/${postId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('게시글이 삭제되었습니다.');
                        window.location.href = '/community';
                    } else {
                        const errorText = await response.text();
                        alert(`게시글 삭제 실패: ${errorText}`);
                    }
                } catch (error) {
                    console.error('삭제 중 오류 발생:', error);
                    alert('게시글 삭제 중 오류가 발생했습니다.');
                }
            }
        });
    });
</script>
{% endblock %}
